<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta content="width=device-width,initial-scale=1,minimal-ui" name="viewport">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,400italic|Material+Icons">
  <link rel="stylesheet" href="https://unpkg.com/vue-material/dist/vue-material.min.css">
  <link rel="stylesheet" href="https://unpkg.com/vue-material/dist/theme/default.css">
  <style>
  </style>
</head>

<body>
  <div id="app">
    <md-app>
      <md-app-drawer md-permanent="full">
        <md-toolbar class="md-transparent" md-elevation="0">
          People
        </md-toolbar>
        <frwa-people />
      </md-app-drawer>
      <md-app-content>
        <frwa-images />
      </md-app-content>
    </md-app>
  </div>

  <script src="https://unpkg.com/vue"></script>
  <script src="https://unpkg.com/vue-material"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

  <!-- <frwa-people> -->
  <script type="text/x-template" id="frwa-people-template">
    <md-list>
      <md-list-item>
        <div>
          <md-chip v-for="person in people" :key="person.id"
            :title="'Created: ' + person.created_at + ', faces: ' + person.detected_faces.length"
            md-deletable @md-delete="deletePerson(person.id)">
            <div draggable @dragstart="dragStart(person.id, $event)">
              {{person.name}}
            </div>
          </md-chip>
        </div>
      </md-list-item>
      <md-list-item>
        <md-field md-inline md-clearable>
          <label>New person...</label>
          <md-input v-model="newPersonName" @keyup.enter="newPerson"></md-input>
        </md-field>
      </md-list-item>
    </md-list>
  </script>
  <script>
    Vue.component('frwa-people', {
      template: '#frwa-people-template',
      data() {
        return {
          people: null,
          newPersonName: null,
        }
      },
      mounted() {
        this.getPeople()
      },
      methods: {
        getPeople() {
          axios
            .get('/entity/Person')
            .then(response => {
              this.people = response.data
            })
            .catch(error => {
              console.log(error)
            })
        },
        newPerson(name) {
          if (!this.newPersonName) return
          var name = this.newPersonName
          this.newPersonName = null
          axios
            .post('/entity/Person', { name: name })
            .then(response => {
              this.people.push(response.data)
            })
        },
        deletePerson(id) {
          axios
            .delete('/entity/Person/' + id)
            .then(response => {
              this.people = this.people.filter(p => p.id != id)
            })
        },
        dragStart(id, event) {
          event.dataTransfer.setData('text/plain', 'person_id=' + id)
        },
      }
    })
  </script>

  <!-- <frwa-image> -->
  <script type="text/x-template" id="frwa-images-template">
    <div @keyup.left="prevImage" @keyup.right="nextImage" tabindex="0">
      <svg v-if="image" :viewBox="'0 0 ' + image.width + ' ' + image.height">
        <image x="0" y="0" :width="image.width" :height="image.height" :xlink:href="image.data_uri"></image>
        <frwa-svg-face v-for="face in faces" :key="face.id"
          :face="face" @update:face="onUpdateFace" />
        <!-- <rect v-for="face in faces" v-bind:key="'rect' + face.id" :x="face.image_region.left" :y="face.image_region.top"
          :width="face.image_region.right - face.image_region.left" :height="face.image_region.bottom - face.image_region.top"
          fill="white" fill-opacity="0" stroke="red" stroke-width="2"
          @dragover.prevent="faceDragOver(face.id, $event)" />
        <g v-for="face in faces" v-bind:key="'g' + face.id">
          <polyline :points="points.map(p=>p[0]+','+p[1]).join(' ')"
            v-for="(points, label) in face.labeled_landmarks" v-bind:key="face.id + label"
            fill="none" stroke="red" />
        </g> -->
      </svg>
      <span v-on:click="prevImage"><md-icon>chevron_left</md-icon></span>
      {{this.imageIndex + 1}} of {{this.imageCount}}
      <span v-on:click="nextImage"><md-icon>chevron_right</md-icon></span>
    </div>
  </script>
  <script>
    Vue.component('frwa-images', {
      template: '#frwa-images-template',
      data() {
        return {
          imageIds: null,
          imageIndex: null,
          image: null,
          faces: null,
        }
      },
      mounted() {
        this.getImageIds()
      },
      computed: {
        imageId() {
          if (!this.imageIds || this.imageIndex === null) return null
          return this.imageIds[this.imageIndex]
        },
        imageCount() {
          if (!this.imageIds) return null
          return this.imageIds.length
        },
      },
      watch: {
        imageId(newId, oldId) {
          if (!newId) return
          axios
            .get('/entity/Image/' + newId)
            .then(response => {
              this.image = response.data
            })
        },
        image(newImage, oldImage) {
          if (!newImage) return
          this.faces = null
          axios
            .all(newImage.detected_faces.map(id => axios.get('/entity/DetectedFace/' + id)))
            .then(responses => {
              this.faces = responses.map(response => response.data)
            })
        },
      },
      methods: {
        getImageIds() {
          axios
            .get('/untagged_image_ids')
            .then(response => {
              this.imageIds = response.data
              this.imageIndex = this.imageIds ? 0 : null
            })
            .catch(error => {
              console.log(error)
            })
        },
        prevImage() {
          if (this.imageIndex === 0) {
            this.imageIndex = this.imageCount - 1
          } else {
            this.imageIndex--
          }
        },
        nextImage() {
          if (this.imageIndex === this.imageCount - 1) {
            this.imageIndex = 0
          } else {
            this.imageIndex++
          }
        },
        onUpdateFace(face) {
          var index = this.faces.findIndex(f => f.id===face.id)
          if (index === -1) {
            console.warn('frwa-images doesn\'t know about face with id ' + face.id)
            return
          }
          // Help Vue detect a change inside of an array: https://vuejs.org/v2/guide/list.html#Caveats
          this.faces.splice(index, 1, face)
        },
      },
    })
  </script>

  <!-- <frwa-svg-face> -->
  <script type="text/x-template" id="frwa-svg-face-template">
    <g @dragover.prevent="dragOver(face.id, $event)" @drop.prevent="drop(face.id, $event)">
      <rect :x="face.image_region.left" :y="face.image_region.top"
        :width="face.image_region.right - face.image_region.left" :height="face.image_region.bottom - face.image_region.top"
        fill="white" fill-opacity="0" stroke="red" stroke-width="2" />
      <polyline v-for="(points, label) in face.labeled_landmarks" :key="face.id + label"
        :points="points.map(p=>p[0]+','+p[1]).join(' ')"
        fill="none" stroke="red" />
    </g>
  </script>
  <script>
    Vue.component('frwa-svg-face', {
      template: '#frwa-svg-face-template',
      props: ['face'],
      methods: {
        getPersonId(event) {
          var data = event.dataTransfer.getData("text/plain")
          if (!data) return
          var match = data.match("^person_id=(.*)")
          if (!match) return
          return match[1]
        },
        dragOver(faceId, event) {
          if (this.getPersonId(event)) {
            event.dataTransfer.dropEffect = 'link'
          }
        },
        drop(faceId, event) {
          var personId = this.getPersonId(event)
          if (!personId) return
          axios
            .post('/link_face_to_person', {
              face_id: faceId,
              person_id: personId,
            })
            .then(result => {
              this.$emit('update:face', result.data)
            })
        },
      },
    })
  </script>
    
  <script>
    Vue.use(VueMaterial.default)

    new Vue({
      el: '#app',
    })
  </script>
</body>

</html>